// Copyright (C) 2021 Toitware ApS.
// Use of this source code is governed by a Zero-Clause BSD license that can
// be found in the tests/LICENSE file.

import expect show *

// Tests that the hash-code field of string slices works.
// At some point the compiler wasn't allocating enough space and
//   allocating a new object would overwrite the hash code of string
//   slices.

main:
  hash-test
  equals-test

hash-test:
  str := "-In ancient times cats were worshipped as gods; they have not forgotten this."
  expected-hash := (str.copy 1).hash-code
  slice := str[1..]
  hash := slice.hash-code
  slice2 := str[1..]
  expect-equals expected-hash hash
  expect-equals expected-hash slice.hash-code
  expect-equals expected-hash slice2.hash-code
  new-object := [1, 2]
  expect-equals expected-hash hash
  expect-equals expected-hash slice.hash-code
  expect-equals expected-hash slice2.hash-code

equals-test:
  // Big enough that slices are real slices and not copies.
  str := """
      Now the number of mice is largely dependent, as every one knows, on the \
      number of cats; and Colonel Newman says, “Near villages and small towns I \
      have found the nests of humble-bees more numerous than elsewhere, which I \
      attribute to the number of cats that destroy the mice.” Hence it is quite \
      credible that the presence of a feline animal in large numbers in a \
      district might determine, through the intervention first of mice and then \
      of bees, the frequency of certain flowers in that district!"""
  ba := str.to-byte-array
  expect-equals ba DARWIN-COW-BYTE-ARRAY
  expect-not-equals str ba  // String and byte arrays do not equal each other.
  expect-not-equals ba str  // String and byte arrays do not equal each other.
  ba-slice1 := ba[3..ba.size - 3]
  ba-slice2 := ba[3..ba.size - 3]
  ba-copy1 := ba.copy 3 (ba.size - 3)
  ba-copy2 := ba.copy 3 (ba.size - 3)
  str-slice1 := str[3..str.size - 3]
  str-slice2 := str[3..str.size - 3]
  str-copy1 := str.copy 3 (str.size - 3)
  str-copy2 := str.copy 3 (str.size - 3)
  cow-slice1 := DARWIN-COW-BYTE-ARRAY[3..DARWIN-COW-BYTE-ARRAY.size - 3]
  cow-slice2 := DARWIN-COW-BYTE-ARRAY[3..DARWIN-COW-BYTE-ARRAY.size - 3]
  cow-copy1 := DARWIN-COW-BYTE-ARRAY.copy 3 (DARWIN-COW-BYTE-ARRAY.size - 3)
  cow-copy2 := DARWIN-COW-BYTE-ARRAY.copy 3 (DARWIN-COW-BYTE-ARRAY.size - 3)

  BYTE-ARRAYS := [ba-slice1, ba-slice2, ba-copy1, ba-copy2, cow-slice1, cow-slice2, cow-copy1, cow-copy2]
  STRINGS := [str-slice1, str-slice2, str-copy1, str-copy2]
  BYTE-ARRAYS.do:
    expect it is ByteArray
  STRINGS.do:
    expect it is string
  ALL := BYTE-ARRAYS + STRINGS
  ALL.do: | left |
    ALL.do: | right |
      if (left is string) != (right is string):
        expect-not-equals left right
      else:
        expect-equals left right

DARWIN-COW-BYTE-ARRAY ::= #[
    0x4e, 0x6f, 0x77, 0x20, 0x74, 0x68, 0x65, 0x20, 0x6e, 0x75, 0x6d, 0x62, 0x65, 0x72, 0x20, 0x6f,
    0x66, 0x20, 0x6d, 0x69, 0x63, 0x65, 0x20, 0x69, 0x73, 0x20, 0x6c, 0x61, 0x72, 0x67, 0x65, 0x6c,
    0x79, 0x20, 0x64, 0x65, 0x70, 0x65, 0x6e, 0x64, 0x65, 0x6e, 0x74, 0x2c, 0x20, 0x61, 0x73, 0x20,
    0x65, 0x76, 0x65, 0x72, 0x79, 0x20, 0x6f, 0x6e, 0x65, 0x20, 0x6b, 0x6e, 0x6f, 0x77, 0x73, 0x2c,
    0x20, 0x6f, 0x6e, 0x20, 0x74, 0x68, 0x65, 0x20, 0x6e, 0x75, 0x6d, 0x62, 0x65, 0x72, 0x20, 0x6f,
    0x66, 0x20, 0x63, 0x61, 0x74, 0x73, 0x3b, 0x20, 0x61, 0x6e, 0x64, 0x20, 0x43, 0x6f, 0x6c, 0x6f,
    0x6e, 0x65, 0x6c, 0x20, 0x4e, 0x65, 0x77, 0x6d, 0x61, 0x6e, 0x20, 0x73, 0x61, 0x79, 0x73, 0x2c,
    0x20, 0xe2, 0x80, 0x9c, 0x4e, 0x65, 0x61, 0x72, 0x20, 0x76, 0x69, 0x6c, 0x6c, 0x61, 0x67, 0x65,
    0x73, 0x20, 0x61, 0x6e, 0x64, 0x20, 0x73, 0x6d, 0x61, 0x6c, 0x6c, 0x20, 0x74, 0x6f, 0x77, 0x6e,
    0x73, 0x20, 0x49, 0x20, 0x68, 0x61, 0x76, 0x65, 0x20, 0x66, 0x6f, 0x75, 0x6e, 0x64, 0x20, 0x74,
    0x68, 0x65, 0x20, 0x6e, 0x65, 0x73, 0x74, 0x73, 0x20, 0x6f, 0x66, 0x20, 0x68, 0x75, 0x6d, 0x62,
    0x6c, 0x65, 0x2d, 0x62, 0x65, 0x65, 0x73, 0x20, 0x6d, 0x6f, 0x72, 0x65, 0x20, 0x6e, 0x75, 0x6d,
    0x65, 0x72, 0x6f, 0x75, 0x73, 0x20, 0x74, 0x68, 0x61, 0x6e, 0x20, 0x65, 0x6c, 0x73, 0x65, 0x77,
    0x68, 0x65, 0x72, 0x65, 0x2c, 0x20, 0x77, 0x68, 0x69, 0x63, 0x68, 0x20, 0x49, 0x20, 0x61, 0x74,
    0x74, 0x72, 0x69, 0x62, 0x75, 0x74, 0x65, 0x20, 0x74, 0x6f, 0x20, 0x74, 0x68, 0x65, 0x20, 0x6e,
    0x75, 0x6d, 0x62, 0x65, 0x72, 0x20, 0x6f, 0x66, 0x20, 0x63, 0x61, 0x74, 0x73, 0x20, 0x74, 0x68,
    0x61, 0x74, 0x20, 0x64, 0x65, 0x73, 0x74, 0x72, 0x6f, 0x79, 0x20, 0x74, 0x68, 0x65, 0x20, 0x6d,
    0x69, 0x63, 0x65, 0x2e, 0xe2, 0x80, 0x9d, 0x20, 0x48, 0x65, 0x6e, 0x63, 0x65, 0x20, 0x69, 0x74,
    0x20, 0x69, 0x73, 0x20, 0x71, 0x75, 0x69, 0x74, 0x65, 0x20, 0x63, 0x72, 0x65, 0x64, 0x69, 0x62,
    0x6c, 0x65, 0x20, 0x74, 0x68, 0x61, 0x74, 0x20, 0x74, 0x68, 0x65, 0x20, 0x70, 0x72, 0x65, 0x73,
    0x65, 0x6e, 0x63, 0x65, 0x20, 0x6f, 0x66, 0x20, 0x61, 0x20, 0x66, 0x65, 0x6c, 0x69, 0x6e, 0x65,
    0x20, 0x61, 0x6e, 0x69, 0x6d, 0x61, 0x6c, 0x20, 0x69, 0x6e, 0x20, 0x6c, 0x61, 0x72, 0x67, 0x65,
    0x20, 0x6e, 0x75, 0x6d, 0x62, 0x65, 0x72, 0x73, 0x20, 0x69, 0x6e, 0x20, 0x61, 0x20, 0x64, 0x69,
    0x73, 0x74, 0x72, 0x69, 0x63, 0x74, 0x20, 0x6d, 0x69, 0x67, 0x68, 0x74, 0x20, 0x64, 0x65, 0x74,
    0x65, 0x72, 0x6d, 0x69, 0x6e, 0x65, 0x2c, 0x20, 0x74, 0x68, 0x72, 0x6f, 0x75, 0x67, 0x68, 0x20,
    0x74, 0x68, 0x65, 0x20, 0x69, 0x6e, 0x74, 0x65, 0x72, 0x76, 0x65, 0x6e, 0x74, 0x69, 0x6f, 0x6e,
    0x20, 0x66, 0x69, 0x72, 0x73, 0x74, 0x20, 0x6f, 0x66, 0x20, 0x6d, 0x69, 0x63, 0x65, 0x20, 0x61,
    0x6e, 0x64, 0x20, 0x74, 0x68, 0x65, 0x6e, 0x20, 0x6f, 0x66, 0x20, 0x62, 0x65, 0x65, 0x73, 0x2c,
    0x20, 0x74, 0x68, 0x65, 0x20, 0x66, 0x72, 0x65, 0x71, 0x75, 0x65, 0x6e, 0x63, 0x79, 0x20, 0x6f,
    0x66, 0x20, 0x63, 0x65, 0x72, 0x74, 0x61, 0x69, 0x6e, 0x20, 0x66, 0x6c, 0x6f, 0x77, 0x65, 0x72,
    0x73, 0x20, 0x69, 0x6e, 0x20, 0x74, 0x68, 0x61, 0x74, 0x20, 0x64, 0x69, 0x73, 0x74, 0x72, 0x69,
    0x63, 0x74, 0x21]

